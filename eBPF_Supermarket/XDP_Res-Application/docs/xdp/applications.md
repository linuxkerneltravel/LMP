## XDP应用分析

### 使用XDP实现轻量级高性能防火墙

netfilter/iptables 是 Linux 中内置的防火墙，其可以根据指定规则进行包过滤、重定向等功能。但是随着网络吞吐量的高速增长，netfilter/iptables 存在着很大的性能瓶颈，导致服务出现不可预测的延迟和性能下降。

netfilter 框架在 IP 层，报文需要经过链路层，IP 层才能被处理，如果是需要丢弃报文，会白白浪费很多资源，影响整体性能，并且 netfilter 框架是一种可自由添加策略规则专家系统，并没有对添加规则进行合并优化，这严重依赖操作人员技术水平，随着规模的增大，规则数量 n 成指数级增长，而报文处理又是 0（n）复杂度，最终性能会直线下降。

可以利用 XDP 打造一个轻量的高性能防火墙，利用 XDP 的底层优势，可以在数据包进入网络协议栈之前对数据包进行判别。根据用户定义的规则，选择对数据包进行丢包、转发等操作，并且可以利用 BPF Map 等探索一种时间复杂度更低的匹配方式，达到减少不必要的资源消耗，提升整体性能的效果。

### 使用AF_XDP改进应用程序的网络性能

AF_XDP和AF_INET,AF_PACKET一样，属于address family的一种，AF_XDP socket 通过 XDP 直接将网卡收到的数据包重定向到用户空间，绕过内核的网络协议栈，能够用来实现高性能的网络包处理。

AF_XDP 可以看作是 XDP 的用户态接口，应用程序需要事先将定制的 XDP程序绑定到对应的网卡上，XDP 程序在内核网卡驱动中会预先处理网卡收到的网络报文，它会将报文发送到一个在用户态可以读写的共享内存（UMEM）当中，应用程序可以直接利用 AF_XDP socket 来接收数据，在 UMEM 中完成对网络报文的读写。

可以利用 AF_XDP 探索一种改进应用程序网络性能的方法，比如数据零拷贝，可以和 XDP 的转发结合（XDP 可重定向至 AF_XDP 类型的 socket），达到性能提升的效果。